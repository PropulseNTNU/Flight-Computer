clear all; close all;
filename = 'DATAFILE.TXT';
delimiterIn = ',';
headerlinesIn = 0;
data = importdata(filename,delimiterIn,headerlinesIn);

%%TODO: IMU_temp = IMU_YAW

timestamp = data(:,1)-data(1,1);
BME_temp = data(:,2);
IMU_temp = data(:,3);
BME_pressure = data(:,4);
BME_altitude = data(:,5);
IMU_acc_x = data(:,6);
IMU_acc_y = data(:,7);
IMU_acc_z = data(:,8);
IMU_roll = data(:,9);
IMU_pitch = data(:,10);
IMU_yaw = data(:,11);
IMU_mag_x = data(:,12);
IMU_mag_y = data(:,13);
IMU_mag_z = data(:,14);
IMU_roll_rate = data(:,15);
IMU_pitch_rate = data(:,16);
IMU_yaw_rate = data(:,17);
IMU_g_accel_x = data(:,18);
IMU_g_accel_y = data(:,19);
IMU_g_accel_z = data(:,20);
IMU_lin_accel_x = data(:,21);
IMU_lin_accel_y = data(:,22);
IMU_lin_accel_z = data(:,23);
IMU_quaternion_x = data(:,24);
IMU_quaternion_y = data(:,25);
IMU_quaternion_z = data(:,26);
IMU_quaternion_w = data(:,27);
states = data(:,28);

%----------------------------------------------------------------------------
time_est=timestamp(12111:12206)/1000;
height=BME_altitude(12111:12206);

h_init=74.27;
a_init=-1.34;
v_init=44.5;
lengde= (12206-12111);

dt=[];
est_v2=[];
time=0;
a=0;

for i =1:lengde
    %dt=append(dt,(time(i+1)-time(i)));
    time=(time_est(i+1)-time_est(i));
    %dif_h=height(i+1)-height(i);
    if i < lengde-2
        est_v2=[est_v2, (height(i+3)-height(i))/(time_est(i+3)-time_est(i))];
        a=a+1;
    elseif i < size(lengde)-1
        est_v2=[est_v2, (height(i+2)-height(i))/(time_est(i+2)-time_est(i))];
    else
        est_v2=[est_v2, (height(i)-height(i+1))/(time_est(i+1)-time_est(i))];
    end
            
    dt=[dt,time];
    %est_v2=[est_v2, height];
    
end
[est_h, est_v]= Kalman_kopi(height,IMU_lin_accel_y(12111:12206), time_est, lengde , h_init, v_init, dt);

%---------------------------------------------------------------------------------
estim_h=[102.85499999999999 116.300432847632 119.37618798158742 120.55271034158099 123.04836695871573 126.1561964832261 127.89061838969424 130.92668383711577 133.64830486980296 136.07805227459266 137.88106457488166 140.6076642435756 143.96577426153257 146.24013368138193 147.6415933926403 150.1285633897814 152.15069092130616 179.944178284157 182.15427064662265 183.9610630594344 187.08689384486982 188.8315046844233 190.3118269620325 193.38712349197618 194.8030458253202 198.00596926343383 199.6519393758447 201.47138292670238 204.21812743147586 207.55638194055788 208.9325287538924 232.92780792824738 234.40897252599444 236.31088373768367 238.20198391396693 239.71287157438178 242.7071466177288 243.88592967345858 246.5292222020728 248.13250061721462 250.35133712992186 252.25094432282802 253.90307643582477 256.180605344783 258.40061099301437 260.53093935157585 261.345557920697 263.70047121041745 266.45959734065366 287.7469853896876 289.79583687564343 290.89458101790797 292.3230609337884 294.31189008106384 296.0525142645857 298.04193420569976 299.5440261761063 302.0595520471842 303.0154248590569 305.0815285461201 306.68263513571895 307.72541411732595 309.93133797569 311.4336887370083 313.810570452623 334.7190370660044 336.81630759028747 338.12466354269804 339.55431360455384 340.7556043402246 342.8220649742901 343.92483061783213 344.80706992804033 346.1645695571426 359.3455961992954 360.7379396819619 362.01514066891997 362.8274932119705 363.7758129095248 365.21448089141234 365.8584528146598 367.1253980930101 367.7069355633086 368.3281481850117 369.5160499046344 370.09889574218556 370.9561773683298 372.0782623517236 372.9680234791694 374.64465301424264 375.1184211651479 376.07685105527304 385.29971696794735 385.4319007656555 386.2177549697831 386.8574572675384 387.0304116036527 387.5786541875049 388.53622518511014 389.1892073700295 389.26006835153464 389.8386939132215 390.78749874960846 390.78983359496743 391.7480961389735 391.7507411983563 392.2280624662699 393.66603565946355 394.60771670115054 394.082334300984 394.15067702789696 398.69526613381316 399.19614816018577 383.17275758645894 401.0108622655797 400.8715456198284 400.87059523468685 401.3479172486079 401.9190272499895 403.4354004418264 402.2456032613381 402.44905680074146 399.8492863203078 400.15069403968266 400.3905287222496 400.501377446365 399.69415378632664 400.4780049648668 399.52405393069415 398.9018032545673 400.81416417454017 400.2434592493676 402.8814636171013]';
estim_v=[51.85 52.117418701457105 52.429853888532804 52.73971723848355 53.053030041331915 53.34886851151543 53.62847466707322 53.935905342158414 54.21971006838356 54.447708306332686 54.68951955509542 54.89759505834177 55.1095224207808 55.326174310448465 55.527762104756185 55.75273349928673 55.992315121113776 56.26377942438555 57.48102225693752 57.652711679039356 57.83051018865772 58.007968563073625 58.141727457065436 58.32044824369305 58.51685017058516 58.678577064430705 58.83557735227963 59.00103248937271 59.18642141791083 59.37190688621571 59.54134897128225 59.77365582605492 61.94142670795393 62.208870492042664 62.50950027639295 62.803015535892726 63.06509349746306 63.39833859317816 63.67795486214134 63.936455723496444 64.23201227773237 64.45820720849751 64.73084141511764 64.97156967150167 65.21962190417693 65.47082495682703 65.70465842988258 65.94742645506233 66.18657270359918 66.48246205911849 66.97130010343557 67.14271513462907 67.31247153197431 67.5023067753054 67.67775984953433 67.85748505045589 68.01896753387867 68.13601276026269 68.27860306144703 68.41308322750513 68.53558853338683 68.65168857357006 68.76231714395554 68.88199229543845 69.01760879883808 69.31645623499439 71.38176566447206 71.80016810956982 72.21819665753357 72.65370714480801 73.06114426068497 73.43968301224909 73.87377081863224 74.27125491516681 74.76906904034733 76.35186889933219 76.71455847163972 77.09907559884441 77.43887171506381 77.78605340079923 78.16958817901555 78.52036821933271 78.83812170804839 79.19854655771276 79.54993399369187 79.91730166716094 80.22892473202256 80.63038663265039 80.99205293812247 81.33582400007836 81.65751045123709 81.98317443423916 82.39748129395015 82.13219613208491 82.42997542896096 82.70413074885353 83.00401084018326 83.29207010133655 83.55296861768 83.85340757153882 84.11962593376384 84.39070578681435 84.6650264443691 84.90815401536321 85.18702176178839 85.43957495713542 85.67072656770227 85.93205196168039 86.18343279432727 86.40934129465458 86.64230511639605 86.91310404182667 84.51934730695551 84.49628877060569 83.44043996043989 83.93784564931784 84.1549704593839 84.3491228143659 84.93551997336637 85.59343771546484 86.19322620285672 86.70309164498757 88.05056620485111 89.75028857680448 91.1729867918901 86.38501550263578 86.33549281633194 86.27050959662154 86.23171723579442 85.5769879480292 87.06786787027468 87.96388328685579 88.6735920447486]';
time_estim=timestamp(6092:(6092+132));


figure(1);
%plot Acceleration
%subplot(5,1,1);

plot(timestamp/1000, IMU_lin_accel_x,'r');
hold on;
plot(timestamp/1000, -1*IMU_lin_accel_y,'g');
plot(timestamp/1000, IMU_lin_accel_z,'b');
grid on;
xlabel('seconds [s]');
ylabel('acceleration [m/s^2]');
l = legend('Lin\_Accel_x','Lin\_Accel_y','Lin\_Accel_z');
xlim([786,801]);
title('Accelerations without gravity');

%plot ROLL/PITCH/YAW
%subplot(5,1,2);
figure(6);
plot(timestamp/1000, IMU_roll,'r');
hold on;
grid on;
plot(timestamp/1000, IMU_pitch,'g');
plot(timestamp/1000, IMU_yaw,'b');
xlabel('seconds [s]');
ylabel('degrees [Â°]');
xlim([786,805]);
legend('Roll_z','Pitch_y','Yaw_x');

title('Euler angles in body frame');

%plot altitude
%subplot(5,1,3);
figure(3);
plot(timestamp(12111:12205)/1000, BME_altitude(12111:12205));
hold on;
plot(timestamp(12111:12205)/1000, est_h);
xlabel('seconds [s]');
grid on;
ylabel('height [m]');
xlim([793,801]);
l = legend('Altitude');
l.FontSize = 16;
title('Altitude');

figure(4);
plot(timestamp(12111:12205)/1000, est_v2);
hold on;
plot(timestamp(12111:12205)/1000, est_v);
legend('h_derivert', 'est_kalman');
%kalman implementert på testoppskytning
% figure(5);
% plot(time_estim/1000, estim_h);
%xlabel('seconds [s]');
%grid on;
%ylabel('height [m]');
%xlim([786,805]);
%l = legend('Altitude');
%l.FontSize = 16;
%legend('est_h');


%plot states
%subplot(5,1,4);
% figure(4);
% plot(timestamp/1000, states);
% xlabel('seconds [s]');
% ylabel('state');
% grid on;
% xlim([786,850]);
% l = legend('states [1=armed,2=burnout,3=airbrakes,4=apogee,5=drogue,6=chute,7=landed]');
% l.FontSize = 16;
% title('State transitions');


%plot temperature
%subplot(5,1,5);
% figure(5);
% plot(timestamp/1000, BME_temp);
% hold on;
% grid on;
% plot(timestamp/1000, IMU_temp);
% xlabel('seconds [s]');
% ylabel('deg celsius [Â°/C]');
% legend('BME Temperature','IMU Temperature');
% xlim([786,850]);
% title('Temperature');

%Plot states
